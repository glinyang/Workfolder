{% extends "reports/base.html" %}

{% block title %}My Reports - Edit{% endblock %}

{% block css_myreports %}class="active"{% endblock %}

{% load reports_extras %} 

{% block content %}
<h4>
	Weekly Report {{ week.week }} - Edit
	<small>
	{% if week.thisweek.week == week.week %} <!-- this week --> 
	   <span class="label label-success">This Week</span> 
    {% endif %}
    </small><br/>
    <small>
        {{ week.monday|date:"Y/n/d D" }} - {{ week.friday|date:"n/d D" }}
	</small>
</h4>

<form id='myform' action="{{ current_path }}" method="post" autocomplete = "off">
	{% csrf_token %}
	<input id="data_changed" type="hidden" value="{{ data_changed }}" />
	
	<table class="table table-bordered table-striped">
		<tfoot>
			<tr>
				<td colspan="2">

					<div class="row">
						<div class="col-md-10">
							 <!--  <a action="cancel" class="btn btn-default" href="{% url 'reports:myreports' %}"> -->
                            <button action="cancel" type="button" class="btn btn-default">
                            <span class="glyphicon glyphicon-remove"></span> Cancel
                            </button>
                            <!--  </a> -->
							<button action="save" type="button" class="btn btn-primary">
								<span class="glyphicon glyphicon-ok"></span> Save
							</button>
						</div>
						<div class="col-md-2" style="text-align: right;">Total
							Efforts:</div>
					</div>

<!-- Modal -->
<div class="modal fade" id="saveModal" tabindex="-1" role="dialog" aria-labelledby="saveModal" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title">Work Hours Confirmation</h4>
      </div>
      <div class="modal-body">
      You worked <strong id="total_efforts_2">00 hours</strong> this week?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">No, back to edit</button>
        <button action="save_confirm" type="button" class="btn btn-primary">Yes, continue to save</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="cancelModal" tabindex="-1" role="dialog" aria-labelledby="cancelModal" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title">Cancel Confirmation</h4>
      </div>
      <div class="modal-body">
      Contents have been changed, discard it?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button action="cancel_confirm" type="button" class="btn btn-warning">Discard it</button>
      </div>
    </div>
  </div>
</div>
				</td>
				<td id="total_efforts">test</td>
			</tr>
		</tfoot>

		<tbody>
			<tr style="display:none;">
				<th class="col-md-2">Projects</th>
				<th class="col-md-*">Work Items</th>
				<th class="col-md-1">Efforts</th>
			</tr>

        {% for form in forms %}
            {% for row in form.rows_count.value|get_range %}
            <tr>
            <!-- the first row need be merged -->
            {% if row|add:0 == 0 %}
                <td  class="col-md-2" rowspan="{{ form.rows_count.value }}"><strong>{{ form.project_name.value }}</strong>
                {{ form.project_name }}<br/>
                {{ form.rows_count }}<br/>
                </td>
            {% endif %}
                <td  class="col-md-*">
                    {{ form|field_item_type:row}}
                    <div class="input-group input-group-sm">
                        <div class="input-group-btn">
                            <button action="item_type" project="{{ form.prefix }}" row={{ row }} type="button" data-toggle="dropdown"
	                                class="btn btn-primary dropdown-toggle">
                                test <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu" role="menu">
                            {% for item_type in item_types %}
                            <li><a action="item_type" item_type="{{ item_type.display_order }}" project="{{ form.prefix }}" row={{ row }} href="#">{{ item_type.text }}</a></li>
                            {% endfor %}
                                <li class="divider"></li>
                                <li><a action="showhide" project="{{ form.prefix }}" row={{ row }} href="#">Show / Hide Comments</a></li>
                                <li class="divider"></li>
                                <li><a id="li_{{ form.prefix }}-item_type_{{ row }}" action="add" project="{{ form.prefix }}" row={{ row }} href="#">Add a Work Item</a></li>
                                <li><a id="li_{{ form.prefix }}-item_type_{{ row }}" action="remove" project="{{ form.prefix }}" row={{ row }} href="#">Remove this Work Item</a></li>
                            </ul>
                        </div>
                    
                        {{ form|field_item_text:row|add_attr:"class:form-control" }}
                        <span class="input-group-btn hide">
                            <button action="check" project="{{ form.prefix }}" row={{ row }} class="btn btn-default" type="button">
                                <span class="glyphicon glyphicon-ok"> </span> Check
                            </button>
                        </span>
                    </div> <!-- /input-group -->
                    {{ form|field_item_comments_status:row}}
                    {{ form|field_item_comments:row|add_attr:"class:form-control top8px hide input-sm,rows:4,placeholder:Comments to this issue" }}
                </td>
                 
                <td class="col-md-1">
                {{ form|field_item_efforts:row }}
                <div class="dropdown">
						<button class="btn btn-default btn-sm dropdown-toggle" action="efforts" project="{{ form.prefix }}" row={{ row }}
							type="button" id="dropdownMenu1" data-toggle="dropdown">
							test <span class="caret"></span>
						</button>
						<ul class="dropdown-menu" role="menu"
							aria-labelledby="dropdownMenu1">
                                <li role="presentation"><a action="efforts" project="{{ form.prefix }}" row={{ row }} role="menuitem" tabindex="-1" href="#">1 hr</a></li>
								<li role="presentation"><a action="efforts" project="{{ form.prefix }}" row={{ row }} role="menuitem" tabindex="-1" href="#">2 hrs</a></li>
								<li role="presentation"><a action="efforts" project="{{ form.prefix }}" row={{ row }} role="menuitem" tabindex="-1" href="#">4 hrs</a></li>
								<li role="presentation"><a action="efforts" project="{{ form.prefix }}" row={{ row }} role="menuitem" tabindex="-1" href="#">6 hrs</a></li>
								<li role="presentation"><a action="efforts" project="{{ form.prefix }}" row={{ row }} role="menuitem" tabindex="-1" href="#">8 hrs</a></li>
								<li role="presentation"><a action="efforts" project="{{ form.prefix }}" row={{ row }} role="menuitem" tabindex="-1" href="#">10 hrs</a></li>
								<li role="presentation"><a action="efforts" project="{{ form.prefix }}" row={{ row }} role="menuitem" tabindex="-1" href="#">12 hrs</a></li>
								<li role="presentation"><a action="efforts" project="{{ form.prefix }}" row={{ row }} role="menuitem" tabindex="-1" href="#">16 hrs</a></li>
<!-- 								<li role="presentation"><a action="efforts" project="{{ form.prefix }}" row={{ row }} role="menuitem" tabindex="-1" href="#">20 hrs</a></li> -->
<!-- 								<li role="presentation"><a action="efforts" project="{{ form.prefix }}" row={{ row }} role="menuitem" tabindex="-1" href="#">24 hrs</a></li> -->
<!-- 								<li role="presentation"><a action="efforts" project="{{ form.prefix }}" row={{ row }} role="menuitem" tabindex="-1" href="#">28 hrs</a></li> -->
<!-- 								<li role="presentation"><a action="efforts" project="{{ form.prefix }}" row={{ row }} role="menuitem" tabindex="-1" href="#">32 hrs</a></li> -->
<!-- 								<li role="presentation"><a action="efforts" project="{{ form.prefix }}" row={{ row }} role="menuitem" tabindex="-1" href="#">36 hrs</a></li> -->
<!-- 								<li role="presentation"><a action="efforts" project="{{ form.prefix }}" row={{ row }} role="menuitem" tabindex="-1" href="#">40 hrs</a></li> -->
						</ul>
					</div>
				</td>
			</tr>
			{% endfor %} {% endfor %}
			<tr>
				<td colspan="3">
					<div class="row">
						<div class="col-md-6">
							<div class="bs-callout bs-callout-success">
								<h4>Plan in This Week</h4>
								<textarea class="form-control input-sm" maxlength="2000" id="plan_in_this_week" name="plan_in_this_week" placeholder="Plan in this week..."
									rows="4" readonly>{{ plan_in_this_week }}</textarea>
							</div>
						</div>
						<div class="col-md-6">
							<div class="bs-callout bs-callout-warning">
								<h4>Plan for Next Week</h4>
								<div id="plan_alert" class="alert alert-warning alert-dismissible" role="alert">
									<a class="close" onclick="$('#plan_alert').hide(); $('#plan_for_next_week').focus();">Ã—</a>  
									What's your plan in next week?
								</div>
								<textarea class="form-control input-sm" maxlength="2000" id="plan_for_next_week" name="plan_for_next_week"
									placeholder="Plan for next week..." rows="4">{{ plan_for_next_week }}</textarea>
							</div>
						</div>
					</div>
				</td>
			</tr>
		</tbody>
	</table>
</form>
{% endblock %}

{% block page_js %}
    <script>
    function get_item_types() {
    	var item_types = {};
        
        {% for item_type in item_types %}
        item_types[{{ item_type.display_order }}] = "{{ item_type.text }}";
        {% endfor %}
        
    	return item_types;
    }
      
    $(document).ready(function() {
    	    $('#plan_alert').hide();
    	    var projects_count = {{ projects_count }};    	
    		for (project = 0; project < projects_count; project++) {
    			rows_count = get_project_input("rows_count", project).val();
    			
    			if(typeof rows_count == "undefined") {
    				continue;
    			}
    			
    		    for (row = 0; row < rows_count; row++) {
    		    	updateItemType(project, row);
    		    	updateItemEfforts(project, row);
    		    	updateItemComments(project, row);
    		    	
    		    	input_item_text = get_row_input("item_text", project, row);
    		    	input_item_text.bind( "input", function() {
    		    		updateTotalEffortsStatus();
    		    	});
    		    }

    		    // set add/remove button status
    		    if (rows_count == 1) {
    		    	get_project_action("remove", project).parent().addClass("disabled");
    		    }
    		    else if (rows_count == 10) {
    		    	get_project_action("add", project).parent().addClass("disabled");
    		    }
    		}
    		updateTotalEffortsStatus();
    		
    		var active_project_index = {{ active_project_index }};
    		var active_row_index = {{ active_row_index }};
    		focusItemText(active_project_index, active_row_index);
    		
    		$("#myform input").change(function() { 
    			$("#data_changed").val("true");
    	    });
    		
    		$("#myform textarea").change(function() { 
    			$("#data_changed").val("true");
            });
    });
    
    function get_total_efforts() {
        var total_efforts = 0;
        var projects_count = {{ projects_count }};     
        for (project = 0; project < projects_count; project++) {
            rows_count = get_project_input("rows_count", project).val();
            
            if(typeof rows_count == "undefined") {
                continue;
            }
            
            for (row = 0; row < rows_count; row++) {
                input_item_text = get_row_input("item_text", project, row);
                input_item_efforts = get_row_input("item_efforts", project, row);
                
                if (input_item_text.val().trim().length > 0 && input_item_efforts.val() > 0) {
                    total_efforts = total_efforts + parseInt(input_item_efforts.val());                 
                }
            }
        }
        
        return total_efforts;
    }
    
    function updateTotalEffortsStatus(is_onload) {
        total_efforts = get_total_efforts();
        if (total_efforts < 40) {
            $("#total_efforts").html("<span class='label label-warning'>" + total_efforts + " hours</span>"); 
            $("#total_efforts_2").html(total_efforts + " hours</span>"); 
        }
        else if (total_efforts == 40) {
            $("#total_efforts").html("<span class='label label-success'>" + total_efforts + " hours</span>");
            $("#total_efforts_2").html(total_efforts + " hours</span>");
        }
        else {
            $("#total_efforts").html("<span class='label label-danger'>" + total_efforts + " hours</span>");
            $("#total_efforts_2").html(total_efforts + " hours</span>");
        }
    }    
    // all controls
    function get_project_input(field_name, project) {
        return $("#id_" + project + "-" + field_name);
    }
    
    function get_row_input(field_name, project, row) {
        return $("#id_" + project + "-" + field_name + "_" + row);
    }
    
    function get_form_button(field_name) {
        return $("button[action='" + field_name + "']");
    }
    
    function get_row_button(field_name, project, row) {
        return $("button[action='" + field_name + "'][project='" + project + "'][row='" + row + "']");
    }
    
    function get_project_action(action, project) {
    	return $("a[action='" + action + "'][project='" + project + "']");
    }
    
    $("a[action='item_type']").click(function(e) {
        e.preventDefault();
        project = $(this).attr("project");
        row = $(this).attr("row");
        item_type = $(this).attr("item_type");
        get_row_input("item_type", project, row).val(item_type);
        updateItemType(project, row);
        $("#data_changed").val("true");
    });
    
     // Set button text and style according to hidden field's value
    function updateItemType(project, row) {
    	input_item_type = get_row_input("item_type", project, row);
    	button_item_type = get_row_button("item_type", project, row);
    	button_check = get_row_button("check", project, row);

    	item_types = get_item_types();
    	
    	// Set button text and style
    	button_item_type.html(item_types[input_item_type.val()] + " <span class='caret'></span>");
    	button_item_type.removeClass();
    	button_check.parent().removeClass();
    	button_check.parent().addClass("input-group-btn hide");
    	
        if (input_item_type.val() == 10) {
        	button_item_type.addClass("btn btn-primary dropdown-toggle");
            // show the check button
            button_check.parent().removeClass("hide");
        }
        else if (input_item_type.val() == 20) {
        	button_item_type.addClass("btn btn-success dropdown-toggle");
        }
        else if (input_item_type.val() == 50) {
        	button_item_type.addClass("btn btn-warning dropdown-toggle");
        }
        else {
        	button_item_type.addClass("btn btn-info dropdown-toggle");
        }
        
        // Set focus to text input box
        focusItemText(project, row);
    }
    
    $("a[action='efforts']").click(function(e) {
        e.preventDefault();
        project = $(this).attr("project");
        row = $(this).attr("row");
        get_row_input("item_efforts", project, row).val(parseInt(this.text));
        updateItemEfforts(project, row);
        
        updateTotalEffortsStatus();
        $("#data_changed").val("true");
    });
    
    function updateItemEfforts(project, row) {
        input_item_efforts = get_row_input("item_efforts", project, row);
        button_item_efforts = get_row_button("efforts", project, row);

        if (input_item_efforts.val() == "1") {
            button_item_efforts.html(input_item_efforts.val() + " hr <span class='caret'></span>");
        }
        else {
            button_item_efforts.html(input_item_efforts.val() + " hrs <span class='caret'></span>");
        }
        
        // Set focus to text input box
        focusItemText(project, row);
    }
    
    function updateItemComments(project, row) {
        input_item_comments = get_row_input("item_comments", project, row);
        input_item_comments_status = get_row_input("item_comments_status", project, row);
        
        input_item_comments.removeClass('hide');
        input_item_comments.removeClass('show');
        //alert(project + "," + row + "," + input_item_comments_status.val());
        input_item_comments.addClass(input_item_comments_status.val());
        if (input_item_comments_status.val() == "hide") {
            focusItemText(project, row);
        }
        else {
        	input_item_comments.focus();
        }
    }
    
    function focusItemText(project, row) {
        // Set focus to text input box
        input_item_text = get_row_input("item_text", project, row);
        input_item_text.focus();
    }
    
    $("a[action='showhide']").click(function(e) {
    	e.preventDefault();
    	project = $(this).attr("project");
        row = $(this).attr("row");
        
        input_item_comments_status = get_row_input("item_comments_status", project, row);
        if (input_item_comments_status.val() == "hide") {
        	input_item_comments_status.val("show");
        }
        else {
        	input_item_comments_status.val("hide");
        }
        updateItemComments(project, row);
    });
    
    $("a[action='add'],[action='remove']").click(function(e) {
    	e.preventDefault();
    	project = $(this).attr("project");
        row = $(this).attr("row");

        // set add/remove button status
        if ($(this).attr("action") == "add") {
            // add 
            if (get_project_action("add", project).parent().hasClass("disabled")) {
                return;
            }
            $('#myform').append("<input type='hidden' name='add' value='add' />");
        }
        else {
            // remove
            if (get_project_action("remove", project).parent().hasClass("disabled")) {
            	return;
            }
        	$('#myform').append("<input type='hidden' name='remove' value='remove' />");
        }
        
        $("#data_changed").val("false");        
        $('#myform').append("<input type='hidden' name='current_project' value='" + project + "' />");
        $('#myform').append("<input type='hidden' name='current_row' value='" + row + "' />");
        $("#myform").submit();
    });
    
    
    $("button[action='check']").click(function() {
        project = $(this).attr("project");
        row = $(this).attr("row");
        
        input_item_text = get_row_input("item_text", project, row);
        text = input_item_text.val()
        
        // Match exactly the ECM######## string, \b for word boundary, "i" for case-insensitive
        var reg_ecm = /\bECM\d{8}\b/i;
        var index = text.search(reg_ecm);
        if (index < 0) {
        	alert("No valid ECM number found, do nothing.");
            focusItemText(project, row);
            return;
        }
        
        btn = $(this)
      	btn.html("<span class='glyphicon glyphicon-transfer'> </span> Connecting CQ, please wait...");
        
        // disabled the ajax alert
        window.alert = function() {};
      	ajaxGet('/get_ecm/?ecm='+text, function(content){
            //on success
            input_item_text.val(content.headline);
            btn.html("<span class='glyphicon glyphicon-ok'> </span> Check");
            
            input_item_comments = get_row_input("item_comments", project, row);
            input_item_comments_status = get_row_input("item_comments_status", project, row);
            if (content.comments.length > 0) {
            	input_item_comments.val(content.comments)
            	input_item_comments_status.val("show");
            	updateItemComments(project, row);
            }
        });
      	
        //$("#data_changed").val("false");
        //$('#myform').append("<input type='hidden' name='check' value='add' />");
        //$('#myform').append("<input type='hidden' name='current_project' value='" + project + "' />");
        //$('#myform').append("<input type='hidden' name='current_row' value='" + row + "' />");
        //$("#myform").submit();
    });
    
   
    $(function(){
        $("[data-hide]").on("click", function(){
            $(this).closest("." + $(this).attr("data-hide")).hide();
        });
    });
    
    
    $("button[action='save']").click(function() {
        total_efforts = get_total_efforts();
        
        if (total_efforts >= 40) {
        	plan_for_next_week = $("#plan_for_next_week");
        	if (plan_for_next_week.val().trim().length == 0) {
        		$('#plan_alert').show();
        		plan_for_next_week.focus();
        		return;
        	}
        }
        
        if (total_efforts != 40) {
        	$('#saveModal').modal({
                keyboard: true
              }) 
        }
        else {
        	$("#data_changed").val("false");
        	$('#myform').append("<input type='hidden' name='save' value='save' />");
            $('#myform').submit();
        }
    });
    
    $("button[action='save_confirm']").click(function() {
    	// Clean the data changed flag, else an alert will be shown on beforeunload event
        $("#data_changed").val("false");
        $('#myform').append("<input type='hidden' name='save' value='save' />");
        $('#myform').submit();
    });
    
    $("button[action='cancel']").click(function() {
        if($("#data_changed").val() == "true") {
            $('#cancelModal').modal({
                keyboard: true
              })
        }
        else {
        	window.location.href = "{% url 'reports:myreports' %}";
        }
    });
    
    $("button[action='cancel_confirm']").click(function() {
    	// Clean the data changed flag, else an alert will be shown on beforeunload event
    	$("#data_changed").val("false");
    	window.location.href = "{% url 'reports:myreports' %}";
    });
    
    $(window).bind('beforeunload', function(e){
    	if($("#data_changed").val() == "true") {
              return "Contents have been changed, discard it?";
        }
        else {
            window.location.href = "{% url 'reports:myreports' %}";
        }
    	})
    </script>
{% endblock %}